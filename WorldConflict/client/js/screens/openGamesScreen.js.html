<script>
var erisk = (function(my) {
    const { $, div, span, onClickOrTap } = domUtils;

    my.openGamesScreen = function(openGames, newGameCallback, playerSeatedCallback) {
        ['overview-panel', 'sound'].map(id => domUtils.showOrHide(id, true));

        erisk.setTutorialScreenVisibility(false);

        onClickOrTap($('new-game-button'), () => {
            erisk.setOpenGamesScreenVisibility(false);
            if (newGameCallback) {
                newGameCallback();
            }
        });

        showUiForOpenGames(openGames, playerSeatedCallback);
        onClickOrTap($('sound'), audio.toggleSound);
        setTimeout(() => erisk.setOpenGamesScreenVisibility(true), 10);
    }

    function showUiForOpenGames(openGames, playerSeatedCallback) {
        $('open-games-panel').innerHTML =
            div(
                {id: 'open-games-list', class: ''},
                openGames.map(openGame => createRowHtmlForGame(openGame)).join('')
            );
        openGames.map(openGame => addHandlersForOpenSeats(openGame, playerSeatedCallback));
    }

    function createRowHtmlForGame(openGame) {
        const turnCount = openGame.turnCount;
        const aiLevelLabel = CONSTS.AI_LEVEL_LABELS[openGame.aiLevel];
        const gid = "game-" + openGame.gameId;

        playerHtmls = openGame.players.map((p) => {
            const player = new Player(p);
            const isButton = player.type === CONSTS.PLAYER_HUMAN_OPEN;
            const pid = 'player' + player.index + '-' + gid;
            const name = player.type === CONSTS.PLAYER_AI ? player.getTextName() + '(AI)' : player.getTextName();

            if (isButton) {
                const openContent = '<span style="color: ' + player.colorStart + ';"><i>' + name + '</i></span>';
                return domUtils.elem('a', {i: pid, c: 'open player-name', href: '#', s: 'font-size: 90%'}, openContent);
            }
            else {
                const nameContent = '<span style="color: ' + player.colorStart + ';">' + name + '</span>';
                return div({ id: pid, c: 'player-name', tt: 'some text' }, nameContent);
            }
        });

        const gameMeta = 'turns: ' + turnCount + ', ' + aiLevelLabel + ' AI';
        playerHtmls.push(div({ c: 'player-name info', style: 'background: ' + "0x000" }, gameMeta));

        return div({ id: gid, c: 'side-control player-box', style: 'background: ' + "0x000" }, playerHtmls.join(''));
    }

    function addHandlersForOpenSeats(openGame, playerSeatedCallback) {
        const gid = "game-" + openGame.gameId;
        openGame.players.map((p, position) =>{
            const player = new Player(p);
            const isOpen = player.type === CONSTS.PLAYER_HUMAN_OPEN;
            const pid = 'player' + player.index + '-' + gid;
            if (isOpen) {
                onClickOrTap($(pid), () => {
                    // Make a call to the server indicating where the player wants to sit.
                    google.script.run
                        .withSuccessHandler(function(gameDataObj) {
                            gameData.initializeFrom(gameDataObj);
                            erisk.gameRenderer.showMap($('map'), gameData.initialGameState);
                            erisk.gameRenderer.updateMapDisplay(gameData.initialGameState);
                            if (playerSeatedCallback) {
                                console.log(`player seated cb - new status = ${gameDataObj.status}`);
                                playerSeatedCallback(gameDataObj.status);
                            }
                        })
                        .withFailureHandler(showError)
                        .seatPlayerAtGame(openGame.gameId, position);
                });
            }
        });
    }

    erisk.setOpenGamesScreenVisibility = function(visible) {
        domUtils.setOverlayVisibility(visible, 'open-games-screen');
    }

    return my;
}(erisk || {}));
</script>
