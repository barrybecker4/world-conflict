<script>
/**
 * Global default configuration that is persistent across page loads
 */
var storage = (function(my) {

    const STORAGE_KEY = 'world-conflict';

    /** Gets user preferences from local storage, or returns default config if not there. */
    my.retrieveSetup = function() {
        if (localStorage) {
            let stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                stored = JSON.parse(stored);
                utils.forEachProperty(getDefaultSetup(), function (value, name) {
                    if (typeof(stored[name]) === 'undefined')
                        stored[name] = value;
                });
                return isSetupValid(stored) ? stored : getDefaultSetup();
            }
        }

        return getDefaultSetup();
    }

    setTimeout(() => {
        my.gameSetup = my.retrieveSetup();
    }, 0);

    my.setDefaultSetup = function() {
        console.log("Reverting to default setup");
        my.gameSetup = getDefaultSetup();
        my.storeSetup();
    }

    // Tries to store user preferences in local storage.
    my.storeSetup = function() {
        if (localStorage) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(my.gameSetup));
        }
    }

    my.isSetupValid = function() {
        return isSetupValid(my.gameSetup);
    }

    // There must be at least one set human player, and there must be at least 2 enabled players.
    function isSetupValid(setup) {
        let numSetPlayers = 0;
        const enabledPlayers = sequenceUtils.sum(setup.playerTypes, function(playerType) {
            if (playerType === CONSTS.PLAYER_HUMAN_SET) {
                numSetPlayers++;
            }
            return (playerType !== CONSTS.PLAYER_OFF) ? 1 : 0;
        });
        return enabledPlayers > 1 && numSetPlayers > 0;
    }

    /**
     * The default game setup screen configuration.
     * firstTimeInstructions are shown only the first time player plays on a given computer (or until cache cleared).
     */
    function getDefaultSetup() {
        return {
            playerTypes: [CONSTS.PLAYER_HUMAN_SET, CONSTS.PLAYER_AI, CONSTS.PLAYER_OFF, CONSTS.PLAYER_AI],
            aiLevel: CONSTS.AI_NICE,
            sound: true,
            turnCount: CONSTS.STANDARD_TURN_COUNT,
            firstTimeInstructions: {},
            humanTimeLimit: CONSTS.STANDARD_HUMAN_TIME_LIMIT,
            mapSize: CONSTS.STANDARD_MAP_SIZE,
        };
    }

    return my;
} (storage || {}))
</script>
