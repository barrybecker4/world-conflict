<script>
erisk.gameRenderer = (function() {

    const my  = {};
    const { elem, div, $,  append, onClickOrTap, setTransform } = domUtils;

    const footerButtonsId = 'footer-buttons';


    // Initial rendering of the game map (regions) as an SVG object.
    my.showMap = function(container, gameState) {
        erisk.mapRenderer.showMap(container, gameState);
    }

    my.updateMapDisplay = function(gameState) {
        erisk.mapRenderer.updateMapDisplay(gameState);
    }

    let displayedState;
    my.updateDisplay = function(gameState) {
        // just for debugging
        if (gameState) {
            displayedState = gameState;
        }

        my.updateMapDisplay(displayedState);
        if (appState.isInGameOrWaiting()) {
            updateInGameUI(displayedState)
        }

        if (displayedState.soundCue) {
            audio.playSound(displayedState.soundCue);
            displayedState.soundCue = null; // probably not needed
        }
    }

    function updateInGameUI(gameState) {
        erisk.gameInfoPanel.render(gameState);
        const decisionState = gameState.moveDecision;
        my.updateButtons(decisionState && decisionState.buttons);
        domUtils.showOrHide('undo-button', erisk.undoEnabled(gameState));
    }

    my.updateButtons = function(buttons, infoText) {
        $(footerButtonsId).innerHTML = '';

        if (infoText) {
            const textBox = div({c: 'description info-text'}, infoText);
            const buttonNode = append(footerButtonsId, textBox);
        }

        (buttons || []).map(createButton);
    }

    function createButton(button, index) {
        if (button.hidden) return;

        let buttonContents = div({}, button.text);
        if (button.description) {
            buttonContents += div({c: 'description'}, button.description);
        }

        const tip = button.tip ? button.tip : '';
        const buttonHTML = elem('a', {href: '#', c: button.disabled ? 'off' : '', tt: tip}, buttonContents);
        const buttonNode = append(footerButtonsId, buttonHTML);
        if (!button.disabled) {
            onClickOrTap(buttonNode, (event) => {
                uiCallbacks.invokeCallback(index, 'build', event);
            });
        }
    }

    my.showPlayerBanner = function(player) {
        my.showBanner(player.colorEnd, player.getName() + "'s turn");
    }

    my.showBanner = function(background, text, delay, duration) {
        delay = delay || 1;
        duration = duration || 1600;
        erisk.oneAtaTime(delay, function() {
            // create a new banner div
            let banner = append('container', div({c: 'banner'}, text));
            let styles = banner.style;

            styles.background = background;
            styles.opacity = 0.0;
            setTransform(banner, transform(-1));

            setTimeout(function() {
                styles.opacity = 1.0;
                setTransform(banner, transform(1));
            }, 0.1 * duration);

            setTimeout(function() {
                styles.opacity = 1.0;
            }, 0.5 * duration);

            setTimeout(function() {
                styles.opacity = 0.0;
            }, 0.7 * duration);

            setTimeout(function() {
                banner.parentNode.removeChild(banner);
            }, duration);
        });

        function transform(offset) {
            return "translate3d(10px, " + 20 * offset + "px, 0)";
             // rotateY(" + (8 + offset * 2) + "deg)"; // this doesn't work on Safari
        }
    }

    return my;
}());
</script>
